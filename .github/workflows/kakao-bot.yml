name: Kakao Daily Bot

on:
  schedule:
    # KST 09:00 = UTC 00:00
    - cron: "0 0 * * *"
    # KST 22:00 = UTC 13:00
    - cron: "0 13 * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode (morning/night)'
        required: true
        default: 'morning'
        type: choice
        options:
          - morning
          - night

permissions:
  contents: write   # state.json 커밋을 위해 필요

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------- (A) Infisical secrets 주입 --------
      # 이 단계에서 KAKAO_* 값들이 env로 들어옴
      - name: Load secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          method: universal
          domain: https://app.infisical.com
          project-slug: ${{ secrets.INFISICAL_PROJECT_ID }}
          env-slug: prod
          secret-path: /KAKAO
          identity-id: ${{ secrets.INFISICAL_IDENTITY_ID }}
          client-secret: ${{ secrets.INFISICAL_IDENTITY_SECRET }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------- (B) 어떤 모드로 실행할지 결정 --------
      - name: Decide run mode
        id: mode
        run: |
          # 수동 실행 시 input 사용, 스케줄 실행 시 시간으로 판단
          if [ -n "${{ github.event.inputs.mode }}" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +'%H')
            if [ "$HOUR" = "00" ]; then
              echo "mode=morning" >> $GITHUB_OUTPUT
            else
              echo "mode=night" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run bot
        run: |
          python -m english_bot.main --mode ${{ steps.mode.outputs.mode }}
        env:
          TZ: Asia/Seoul
          IDIOM_DIR: data/english-data
          STATE_PATH: data/english-data/state/state.json

      # -------- (C) state.json 변경사항 커밋 --------
      - name: Commit state if changed
        run: |
          if git status --porcelain | grep data/english-data/state/state.json; then
            git config user.name "kakao-bot"
            git config user.email "kakao-bot@users.noreply.github.com"
            git add data/english-data/state/state.json
            git commit -m "chore(state): update daily bot state"
            git push
          else
            echo "No state change"
          fi
