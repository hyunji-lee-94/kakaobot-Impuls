name: Kakao Daily Bot

on:
  schedule:
    # KST 09:00 = UTC 00:00
    - cron: "12 2 * * *"
    # KST 22:00 = UTC 13:00
    - cron: "7 13 * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode (morning/night)'
        required: true
        default: 'morning'
        type: choice
        options:
          - morning
          - night

permissions:
  contents: write   # state.json Ïª§Î∞ãÏùÑ ÏúÑÌï¥ ÌïÑÏöî
  issues: write     # ÌÜ†ÌÅ∞ ÎßåÎ£å ÏïåÎ¶º issue ÏÉùÏÑ±Ïö©

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------- (A) Infisical secrets Ï£ºÏûÖ --------
      # Ïù¥ Îã®Í≥ÑÏóêÏÑú KAKAO_* Í∞íÎì§Ïù¥ envÎ°ú Îì§Ïñ¥Ïò¥
      - name: Load secrets from Infisical
        uses: Infisical/secrets-action@v1.0.15
        with:
          method: universal
          domain: https://app.infisical.com
          project-slug: ${{ secrets.INFISICAL_PROJECT_ID }}
          env-slug: prod
          secret-path: /KAKAO
          client-id: ${{ secrets.INFISICAL_IDENTITY_ID }}
          client-secret: ${{ secrets.INFISICAL_IDENTITY_SECRET }}

      - name: Debug - Check secrets loaded
        run: |
          echo "KAKAO_REST_API_KEY exists: $([[ -n \"$KAKAO_REST_API_KEY\" ]] && echo 'YES' || echo 'NO')"
          echo "KAKAO_REFRESH_TOKEN exists: $([[ -n \"$KAKAO_REFRESH_TOKEN\" ]] && echo 'YES' || echo 'NO')"
          echo "KAKAO_CLIENT_SECRET exists: $([[ -n \"$KAKAO_CLIENT_SECRET\" ]] && echo 'YES' || echo 'NO')"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------- (B) Ïñ¥Îñ§ Î™®ÎìúÎ°ú Ïã§ÌñâÌï†ÏßÄ Í≤∞Ï†ï --------
      - name: Decide run mode
        id: mode
        run: |
          # ÏàòÎèô Ïã§Ìñâ Ïãú input ÏÇ¨Ïö©, Ïä§ÏºÄÏ§Ñ Ïã§Ìñâ Ïãú ÏãúÍ∞ÑÏúºÎ°ú ÌåêÎã®
          if [ -n "${{ github.event.inputs.mode }}" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +'%H')
            if [ "$HOUR" = "00" ]; then
              echo "mode=morning" >> $GITHUB_OUTPUT
            else
              echo "mode=night" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run bot
        id: bot
        run: |
          python -u -m english_bot.main --mode ${{ steps.mode.outputs.mode }} 2>&1 | tee bot_output.txt
          if grep -q "TOKEN_RENEWAL_NEEDED" bot_output.txt; then
            echo "token_warning=true" >> $GITHUB_OUTPUT
          fi
        env:
          TZ: Asia/Seoul
          IDIOM_DIR: data/english-data
          STATE_PATH: data/english-data/state/state.json
          PYTHONUNBUFFERED: "1"

      - name: Create token renewal issue
        if: steps.bot.outputs.token_warning == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Kakao Refresh Token Renewal Required';
            const body = `## Token Expiring Soon!\n\nThe Kakao refresh token will expire within 1 day.\n\n### Action Required:\n1. Go to [Kakao Developers](https://developers.kakao.com/)\n2. Generate a new refresh token\n3. Update the token in Infisical:\n   \`\`\`bash\n   infisical secrets set "KAKAO_REFRESH_TOKEN=ÏÉàÌÜ†ÌÅ∞Í∞í" --env=prod --path=/KAKAO --type=shared\n   \`\`\`\n\n*This issue was auto-generated by the Kakao Bot workflow.*`;
            
            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'token-renewal'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['token-renewal', 'urgent']
              });
              console.log('Token renewal issue created!');
            } else {
              console.log('Token renewal issue already exists, skipping...');
            }

      # -------- (C) state.json Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ïª§Î∞ã --------
      - name: Commit state if changed
        run: |
          if git status --porcelain | grep data/english-data/state/state.json; then
            git config user.name "kakao-bot"
            git config user.email "kakao-bot@users.noreply.github.com"
            git add data/english-data/state/state.json
            git commit -m "chore(state): update daily bot state"
            git push
          else
            echo "No state change"
          fi
